#!/bin/sh

# Upload the currently-copied image URL to i.gabebw.com
#
# Options:
#
#   -f local_path: Upload a local file FROM here (if not given, uses copied URL)
#   -t remote_name: Upload the file TO here, with this name.
#
# USAGE:
#
# Upload the image whose URL I just copied and keep the same name:
#
#   icopy
#
# Upload a local image named `from.jpg` and upload as `to.jpg`
#
#   icopy -f flip.jpg -t to.jpg
#
# Upload the copied image URL and upload as flip.{jpg,png,gif,etc}
#
#   icopy -t flip

set -e

usage() {
  cat <<USAGE
Usage: icopy [-f local-name.gif] [-t remote-name.gif]

Options:

  -f local_path: Upload a local file FROM here (if not given, uses copied URL)
  -t remote_name: Upload the file TO here, with this name.
USAGE
  exit 0
}

while getopts "t:f:h" opt; do
  case $opt in
    h)
      usage
      ;;
    f)
      from="$OPTARG"
      ;;
    t)
      to="$OPTARG"
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      exit 1
      ;;
  esac
done

if [ -n "$from" ]; then
  # Only add an extension if it's from the web
  if [[ "$from" = http* ]]; then
    extension=${from##*.}
    to=${to:-$(basename "$from").$extension}
  else
    to=${to:-$(basename "$from")}
  fi

  echo "$from -> $to" >&2
  upload-image "$from" "$to"
else
  from="icopy_file-$$.image"
  url=$(pbpaste)
  extension=${url##*.}
  if [ -n "$to" ]; then
    to="${to}.${extension}"
  else
    to=$(basename "$url")
  fi
  echo "$url -> $to" >&2
  curl --silent --output "$from" "$url"
  upload-image "$from" "$to"
  rm "$from"
fi
