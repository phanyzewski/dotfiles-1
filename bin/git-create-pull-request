#!/bin/sh

# Open a PR, edit the description in Vim, copy the url to the clipboard, and
# open the PR in the browser.

set -e
set -o pipefail

on_master() {
  [ "$(git rev-parse HEAD)" = "$(git rev-parse master)" ]
}

error() {
  echo "\n!!! $@" >&2
  exit 1
}

if on_master; then
  error "You're already on master"
fi

find_pull_request_template(){
  for template in PULL_REQUEST_TEMPLATE* .github/PULL_REQUEST_TEMPLATE*; do
    if [ -r "$template" ]; then
      printf "$template"
      break
    fi
  done
}

is_hired(){
  [ "$(basename "$(pwd)")" = "hired" ]
}

link_to_hired_ticket_number(){
  local number=$(git rev-parse --abbrev-ref HEAD | sed -E 's/gbw-([A-Z]+-[0-9]+).*/\1/')
  echo "Ticket: [${number}](https://hiredteam.atlassian.net/browse/${number})"
}

commit_message_file=$(mktemp -t commit_message_file)
number_of_commits=$(git rev-list origin/master..HEAD --count)
commentchar=$(git config --get core.commentchar || printf "#")
pull_request_template=$(find_pull_request_template)

if is_hired; then
  cat "$pull_request_template" >> "$commit_message_file"
  echo "$(link_to_hired_ticket_number)" >> "$commit_message_file"
  echo "\nbot review me @hired/internal-xp" >> "$commit_message_file"
  echo >> "$commit_message_file"
  git log --format="%h (%aN, %ar)%n%w(78,3,3)%s%n%+b" origin/master..HEAD >> "$commit_message_file"
elif [ "$number_of_commits" -eq 1 ]; then
  git log -1 --format=%B > "$commit_message_file"
  if [ -n "$pull_request_template" ]; then
    cat "$pull_request_template" >> "$commit_message_file"
  fi
else
  echo "[Descriptive title goes here]" > "$commit_message_file"
  echo >> "$commit_message_file"
  if [ -n "$pull_request_template" ]; then
    cat "$pull_request_template" >> "$commit_message_file"
  fi
  echo >> "$commit_message_file"
  git log --format="$commentchar %h (%aN, %ar)%n%w(78,3,3)%s%n%+b" origin/master..HEAD >> "$commit_message_file"
fi

vim -c "set ft=gitcommit" "$commit_message_file"
message_without_comments=$(egrep -v "^${commentchar}" "$commit_message_file")

if hub pull-request -m "$message_without_comments" | pbcopy; then
  open "$(pbpaste)"
fi
